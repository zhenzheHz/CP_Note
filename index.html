<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>競程筆記</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<!-- Marked.js -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Prism CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

<!-- Prism JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>

<!-- MathJax -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true
  },
  startup: {
    typeset: false
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
/* --- CSS 簡化，保留主要樣式 --- */
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --primary:#6366f1; --primary-light:#818cf8; --bg-primary:#0f172a; --bg-secondary:#1e293b; --bg-tertiary:#334155; --text-primary:#f1f5f9; --text-secondary:#cbd5e1; --border:#334155;
}
body { font-family:'Inter',sans-serif; background:var(--bg-primary); color:var(--text-primary); line-height:1.6; overflow-x:hidden; }
.header { position:fixed; top:0; left:0; right:0; height:70px; background:rgba(15,23,42,0.8); backdrop-filter:blur(12px); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 2rem; z-index:1000; }
.logo { font-size:1.5rem; font-weight:700; background:linear-gradient(135deg,#f093fb 0%,#f5576c 50%,#ffd140 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; cursor:pointer; }
.menu-toggle { display:none; background:none; border:none; color:var(--text-primary); font-size:1.5rem; cursor:pointer; padding:0.5rem; margin-right:1rem; }
.sidebar { position:fixed; left:0; top:70px; bottom:0; width:280px; background:var(--bg-secondary); border-right:1px solid var(--border); overflow-y:auto; transition:transform 0.3s ease; z-index:100; }
.sidebar.open { transform:translateX(0); }
.sidebar-section { max-height:0; overflow:hidden; transition:max-height 0.3s ease; }
.sidebar-section.expanded { max-height:1000px; }
.main { margin-left:280px; margin-top:70px; padding:3rem; min-height:calc(100vh-70px); transition:margin-left 0.3s ease; }
.content { max-width:900px; margin:0 auto; }
.content h1 { font-size:2.5rem; font-weight:700; margin-bottom:1.5rem; text-align:center; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.content pre { background:var(--bg-secondary); border:1px solid var(--border); border-radius:12px; padding:1rem; overflow-x:auto; margin:1.5rem 0; }
.content code { font-family:'JetBrains Mono', monospace; background:var(--bg-secondary); padding:0.2rem 0.5rem; border-radius:4px; font-size:0.9em; color:var(--primary-light); }
@media(max-width:768px) { .menu-toggle { display:block; } .sidebar { transform:translateX(-100%); } .main { margin-left:0; padding:2rem 1.5rem; } }
</style>
</head>

<body>
<header class="header">
  <button class="menu-toggle" id="menuToggle">☰</button>
  <div class="logo" id="homeLink">🏆 競程講義</div>
</header>

<nav class="sidebar" id="sidebar">
  <div class="sidebar-content" id="sidebarContent">
    <div class="loading">載入選單中...</div>
  </div>
</nav>

<main class="main" id="main">
  <div class="content" id="content">
    <div class="loading">載入內容中...</div>
  </div>
</main>

<script>
// marked 設定
marked.setOptions({
  gfm: true,
  breaks: true,
  highlight: function(code, lang){
    if(Prism.languages[lang]){
      return Prism.highlight(code, Prism.languages[lang], lang);
    }
    return code;
  }
});

let currentPath = '';

// 載入 markdown
async function loadMarkdown(path){
  try{
    let filePath = path.replace(/^\.?\//,'');
    const res = await fetch(filePath);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.text();
  }catch(e){ console.error(e); return null; }
}

// 顯示內容
async function renderContent(path){
  const contentEl = document.getElementById('content');
  contentEl.innerHTML = '<div class="loading">載入內容中...</div>';
  const markdown = await loadMarkdown(path);
  if(markdown){
    contentEl.innerHTML = marked.parse(markdown);

    // Prism 高亮
    contentEl.querySelectorAll('pre code').forEach(block=>{
      const lang = block.className.replace('language-','')||'cpp';
      if(Prism.languages[lang]){
        block.innerHTML = Prism.highlight(block.textContent, Prism.languages[lang], lang);
        block.classList.add('language-'+lang);
      }
    });

    // MathJax 渲染
    if(window.MathJax && window.MathJax.typesetPromise){
      MathJax.typesetPromise([contentEl]).catch(err=>console.error(err));
    }

    window.scrollTo(0,0);
    currentPath = path;
  }else{
    contentEl.innerHTML = `<div class="error"><h3>❌ 載入失敗</h3><p>無法載入檔案: ${path}</p></div>`;
  }
}

// 顯示側邊欄
async function renderSidebar(){
  const sidebarEl = document.getElementById('sidebarContent');
  const markdown = await loadMarkdown('_sidebar.md');
  if(markdown){
    sidebarEl.innerHTML = marked.parse(markdown);
    const sections = sidebarEl.querySelectorAll('strong,p');
    sections.forEach(section=>{
      let next = section.nextElementSibling;
      while(next && next.tagName!=='UL') next=next.nextElementSibling;
      if(next){
        const wrapper = document.createElement('div');
        wrapper.className='sidebar-section';
        next.parentNode.insertBefore(wrapper,next);
        wrapper.appendChild(next);
        section.addEventListener('click',()=>{section.classList.toggle('expanded'); wrapper.classList.toggle('expanded');});
      }
    });

    const links = sidebarEl.querySelectorAll('a');
    links.forEach(link=>{
      const href = link.getAttribute('href');
      if(href && !href.startsWith('http')){
        link.addEventListener('click',e=>{
          e.preventDefault();
          links.forEach(l=>l.classList.remove('active'));
          link.classList.add('active');
          const cleanHref = href.replace(/^\.?\//,'');
          window.location.hash = cleanHref;
          if(window.innerWidth<=768) document.getElementById('sidebar').classList.remove('open');
        });
      }
    });
  }else{
    sidebarEl.innerHTML=`<div class="error"><p>❌ 無法載入選單</p></div>`;
  }
}

// hash 路由
function handleRouting(){
  const hash = window.location.hash.slice(1) || 'README.md';
  renderContent(hash);
  const links = document.querySelectorAll('#sidebarContent a');
  links.forEach(link=>{
    const href = link.getAttribute('href')||'';
    if(href.replace(/^\.?\//,'')===hash.replace(/^\.?\//,'')){
      link.classList.add('active');
    }else link.classList.remove('active');
  });
}

// 初始化
async function init(){
  await renderSidebar();
  handleRouting();
}

document.getElementById('menuToggle').addEventListener('click',()=>{document.getElementById('sidebar').classList.toggle('open');});
document.getElementById('main').addEventListener('click',()=>{if(window.innerWidth<=768) document.getElementById('sidebar').classList.remove('open');});
document.getElementById('homeLink').addEventListener('click',()=>{window.location.hash='README.md';});
window.addEventListener('hashchange',handleRouting);

init();
</script>
</body>
</html>
